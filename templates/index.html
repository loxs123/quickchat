<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å¤§æ¨¡å‹å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Highlight.js ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- marked.js ç”¨äºè§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- MathJax æ•°å­¦å…¬å¼ -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="toolbar">
        <button onclick="streamText('translate')">ç¿»è¯‘</button>
        <button onclick="streamText('polish')">æ¶¦è‰²</button>
        <button onclick="streamText('solve')">è§£é¢˜</button>
        <button onclick="streamText('é»˜è®¤')">å…¶ä»–</button>
    </div>
    <!-- <div class="container">
        <textarea id="inputText" placeholder="è¯·è¾“å…¥æ–‡æœ¬..."></textarea>
        <div id="outputMarkdown" class="markdown-box">
            <div id="toc"></div>
            <div id="content"></div>
            <div id="copySection" style="display: none;">
                <button id="copyBtn" title="å¤åˆ¶ Markdown">ğŸ“‹ å¤åˆ¶</button>
                <span id="copyStatus" style="margin-left: 10px; color: green;"></span>
            </div>
        </div>
    </div> -->
    <div class="container">
        <textarea id="inputText" placeholder="è¯·è¾“å…¥æ–‡æœ¬..."></textarea>
        <div class="resizer"></div> <!-- æ‹–åŠ¨åˆ†éš”çº¿ -->
        <div id="outputMarkdown" class="markdown-box">
            <div id="toc"></div>
            <div id="content"></div>
            <div id="copySection" style="display: none;">
                <button id="copyBtn" title="å¤åˆ¶ Markdown">ğŸ“‹ å¤åˆ¶</button>
                <span id="copyStatus" style="margin-left: 10px; color: green;"></span>
            </div>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨ç”Ÿæˆ TOC
        function generateTOC(container) {
            const toc = document.getElementById("toc");
            toc.innerHTML = ""; // æ¸…ç©ºæ—§ç›®å½•

            const headers = container.querySelectorAll("h1, h2, h3");

            if (headers.length === 0) {
                toc.style.display = "none";  // æ²¡æœ‰æ ‡é¢˜åˆ™éšè—
                return;
            }

            toc.style.display = "block";  // æœ‰æ ‡é¢˜åˆ™æ˜¾ç¤º
            toc.innerHTML = "<h3>ç›®å½•</h3>";
            headers.forEach((header, index) => {
                const id = "heading-" + index;
                header.id = id;
                const link = document.createElement("a");
                link.href = "#" + id;
                link.innerText = header.innerText;
                link.style.display = "block";
                link.style.marginLeft = (parseInt(header.tagName[1]) - 1) * 10 + "px";
                toc.appendChild(link);
            });
        }

        let latestRawMarkdown = "";

        function submitText(mode) {
            const inputText = document.getElementById("inputText").value;
            fetch("/process", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: inputText, mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                latestRawMarkdown = data.result;  // ä¿å­˜åŸå§‹ Markdown æ–‡æœ¬
                const contentDiv = document.getElementById("content");
                contentDiv.innerHTML = marked.parse(data.result);
                generateTOC(contentDiv);
                hljs.highlightAll(); // é«˜äº®ä»£ç 
                MathJax.typeset();   // æ¸²æŸ“å…¬å¼
                
                const copySection = document.getElementById("copySection");
                // æ˜¾ç¤ºæˆ–éšè—å¤åˆ¶æŒ‰é’®
                if (latestRawMarkdown.trim() !== "") {
                    copySection.style.display = "block";
                } else {
                    copySection.style.display = "none";
                }
            });
        }

        // æµå¼å‡½æ•°
        function streamText(mode) {
            const inputText = document.getElementById("inputText").value;
            const contentDiv = document.getElementById("content");
            const tocDiv = document.getElementById("toc");
            const copySection = document.getElementById("copySection");

            // é‡ç½®
            contentDiv.innerHTML = "";
            tocDiv.innerHTML = "";
            tocDiv.style.display = "none";
            copySection.style.display = "none";
            latestRawMarkdown = "";

            fetch("/stream_process", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({text: inputText, mode})
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                function readChunk() {
                    reader.read().then(({done, value}) => {
                        if (done) {
                            // æµç»“æŸåï¼Œç¡®ä¿æœ€åä¸€æ¬¡æ¸²æŸ“å¹¶è§¦å‘é«˜äº®å’Œå…¬å¼ã€TOCã€å¤åˆ¶æŒ‰é’®
                            renderAll();
                            return;
                        }
                        // è§£ç å¹¶æ‹†åˆ† SSE å—
                        const chunk = decoder.decode(value, {stream: true});
                        chunk.split("-$#$#$#$-")
                            .filter(line => line.startsWith("data: "))
                            .forEach(line => {
                                const data = line.replace(/^data: /, "");
                                if (!data.startsWith("[ERROR]")) {
                                    latestRawMarkdown += data;
                                    // æ¯æ”¶åˆ°ä¸€æ®µå°±æ¸²æŸ“ä¸€æ¬¡
                                    renderPartial();
                                }
                            });
                        // ç»§ç»­è¯»
                        readChunk();
                    });
                }
                readChunk();
            });
        }

        // å±€éƒ¨æ¸²æŸ“ï¼šæ›´æ–° Markdownï¼Œä¾›æµå¼å¢é‡å¯è§
        function renderPartial() {
            const contentDiv = document.getElementById("content");
            contentDiv.innerHTML = marked.parse(latestRawMarkdown);
        }

        // ç»“æŸæ¸²æŸ“ï¼šé«˜äº®ã€å…¬å¼ã€TOCã€å¤åˆ¶æŒ‰é’®
        function renderAll() {
            const contentDiv = document.getElementById("content");
            const tocDiv = document.getElementById("toc");
            const copySection = document.getElementById("copySection");

            // æœ€ç»ˆå®Œæ•´æ¸²æŸ“
            contentDiv.innerHTML = marked.parse(latestRawMarkdown);

            // ä»£ç é«˜äº®
            hljs.highlightAll();

            // MathJax æ¸²æŸ“å…¬å¼
            MathJax.typeset();

            // ç”Ÿæˆç›®å½•ï¼ˆå¦‚æœæœ‰æ ‡é¢˜ï¼‰
            generateTOC(contentDiv);

            // æ˜¾ç¤ºå¤åˆ¶æŒ‰é’®
            if (latestRawMarkdown.trim()) {
                copySection.style.display = "block";
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.setAttribute("readonly", "");
            textarea.style.position = "absolute";
            textarea.style.left = "-9999px";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
        }

        // å¤åˆ¶ Markdown å†…å®¹
        document.addEventListener("DOMContentLoaded", () => {
            const copyBtn = document.getElementById("copyBtn");
            const copyStatus = document.getElementById("copyStatus");

            copyBtn.addEventListener("click", () => {
                if (navigator.clipboard && location.protocol === "https:") {
                    navigator.clipboard.writeText(latestRawMarkdown).then(() => {
                        copyStatus.textContent = "å·²å¤åˆ¶ï¼";
                    }).catch(() => {
                        try {
                            fallbackCopy(latestRawMarkdown);
                            copyStatus.textContent = "å·²å¤åˆ¶ï¼";
                            setTimeout(() => (copyStatus.textContent = ""), 2000);
                        } catch (err) {
                            copyStatus.textContent = "å¤åˆ¶å¤±è´¥";
                        }
                    });
                } else {
                    try {
                        fallbackCopy(latestRawMarkdown);
                        copyStatus.textContent = "å·²å¤åˆ¶ï¼";
                        setTimeout(() => (copyStatus.textContent = ""), 2000);
                    } catch (err) {
                        copyStatus.textContent = "å¤åˆ¶å¤±è´¥";
                    }
                }

            });
        });
    </script>

    <script>
        // è·å–å…ƒç´ 
        const resizer = document.querySelector('.resizer');
        const leftPanel = document.getElementById('inputText');
        const rightPanel = document.getElementById('outputMarkdown');
        const container = document.querySelector('.container');

        // åˆå§‹æ¯”ä¾‹
        let leftRatio = 0.5;
        let rightRatio = 0.5;

        // æ›´æ–°CSSå˜é‡
        function updateRatios() {
            container.style.setProperty('--left-ratio', leftRatio);
            container.style.setProperty('--right-ratio', rightRatio);
        }

        // åˆå§‹åŒ–
        updateRatios();

        // ä½¿ç”¨mousedown/mousemove/mouseupäº‹ä»¶
        resizer.addEventListener('mousedown', startResize);

        function startResize(e) {
            e.preventDefault();
            
            // æ·»åŠ ä¸´æ—¶æ ·å¼
            resizer.style.backgroundColor = '#ccc';
            document.body.style.cursor = 'col-resize';
            
            // è®°å½•åˆå§‹ä½ç½®
            const startX = e.clientX;
            const containerWidth = container.offsetWidth;
            const startLeftWidth = leftPanel.offsetWidth;
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            const moveHandler = function(e) {
                e.preventDefault();
                
                // è®¡ç®—æ–°çš„å®½åº¦
                const dx = e.clientX - startX;
                const newLeftWidth = Math.max(100, Math.min(containerWidth - 100, startLeftWidth + dx));
                
                // è®¡ç®—æ–°çš„æ¯”ä¾‹
                leftRatio = newLeftWidth / containerWidth;
                rightRatio = 1 - leftRatio;
                
                // æ›´æ–°æ˜¾ç¤º
                updateRatios();
            };
            
            // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
            const upHandler = function() {
                // ç§»é™¤ä¸´æ—¶æ ·å¼
                resizer.style.backgroundColor = '';
                document.body.style.cursor = '';
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            };
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—æ¯”ä¾‹
        window.addEventListener('resize', () => {
            // ä¿æŒå½“å‰æ¯”ä¾‹ä¸å˜
            updateRatios();
        });
    </script>   
</body>
</html>
